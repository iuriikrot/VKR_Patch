# План проекта с нуля: команды и ключевые моменты

План рассчитан на пошаговую работу: каждый шаг выполняется, проверяется
и согласуется перед переходом к следующему.

ВАЖНО: модель PatchTST мы НЕ пишем с нуля. Используем готовый self-supervised
reference-код из официального репозитория:
https://github.com/yuqinie98/PatchTST/tree/main?tab=readme-ov-file

---

## Шаг 1. Подготовка окружения
- Цель: воспроизводимая среда для экспериментов.
- Важные моменты:
  - Зафиксируй версии библиотек (для повторяемости результатов).
  - Проверь, что Python видит нужные пакеты.
  - Запиши версии ключевых библиотек (NumPy, pandas, torch).
- Пауза для подтверждения пользователем.

## Шаг 2. Зафиксировать условия эксперимента
- Цель: определить задачу, метрики, период, тикеры, частоту ребалансировки, ограничения.
- Важные моменты:
  - Нужен единый конфиг, где будут все параметры данных и всех моделей.
  - Этот конфиг используется во всех скриптах и ноутбуках.
  - Явно задать окно train/test (например 5 лет / 1 месяц).
  - Явно задать ограничения на веса (min/max, long-only, gross exposure).
  - Зафиксировать безрисковую ставку и метод ковариации.
  - Зафиксировать способ оценки ковариации (sample или Ledoit-Wolf).
  - Зафиксировать seed и режим детерминизма (если нужен повторяемый результат).
- Пауза для подтверждения пользователем.

## Шаг 3. Загрузка цен
- Цель: получить цены (Adjusted Close).
- Важные моменты:
  - Тикеры и даты должны совпадать с конфигом.
  - Не должно быть пустых колонок или тикеров с одними NaN.
  - Убедиться, что есть именно Adjusted Close (а не Close).
- Пауза для подтверждения пользователем.

## Шаг 4. Построение лог-доходностей
- Цель: подготовить данные для бэктеста.
- Важные моменты:
  - Длина данных = N-1 относительно цен.
  - Проверить NaN/inf после преобразований.
  - Удалить пропуски: `dropna()` по строкам (если есть NaN хотя бы в одном тикере).
- Пауза для подтверждения пользователем.

## Шаг 5. Валидация структуры данных
- Цель: убедиться, что данные синхронизированы по датам.
- Важные моменты:
  - Нет пропусков дат, дубликатов, рассинхронизации колонок.
  - Проверь, что формат дат и частота соответствуют торговым дням.
  - Проверь отсутствие утечки данных: train использует только прошлые даты.
  - Убедись, что календарь ребалансировки одинаковый для всех моделей.
- Пауза для подтверждения пользователем.

## Шаг 6. Историческое среднее (Historical Mean)
- Цель: бэктест Марковица с μ = историческое среднее.
- Важные моменты:
  - Сделать короткий пробный прогон (1-2 тикера или укороченный период).
  - Ребалансировка раз в месяц, внутри месяца buy-and-hold.
  - Сохраняй веса на каждом шаге (для последующего анализа).
  - Убедиться, что окна train/test совпадают с другими моделями.
  - Проверить, что ограничения оптимизатора реально соблюдаются (min/max, long-only, gross exposure).
- Пауза для подтверждения пользователем.

## Шаг 7. StatsForecast AutoARIMA
- Цель: прогноз 21 дневной доходности и расчет μ.
- Важные моменты:
  - Горизонт прогноза = 21 день.
  - Нужен fallback, если модель не сошлась по тикеру.
  - Контролировать параметры AutoARIMA (max_p, max_d, max_q, stepwise).
- Пауза для подтверждения пользователем.

## Шаг 8. PatchTST (self-supervised reference)
- Цель: прогноз с PatchTST и расчет μ.
- Важные моменты:
  - Pretrain + finetune на каждом шаге бэктеста.
  - Проверить корректный выбор устройства (MPS/CUDA/CPU).
  - Зафиксировать режим обучения (fast/full) и все гиперпараметры.
  - Логировать время обучения и загрузку ресурсов.
- Пауза для подтверждения пользователем.

## Шаг 9. Метрики прогноза (месячные)
- Цель: сравнить прогноз месячной доходности с фактом.
- Важные моменты:
  - Месячный прогноз = сумма 21 дневной лог-доходности.
  - Hit Rate считать по знаку, игнорируя нули/NaN.
  - Сохранять прогнозы и факты по каждому тикеру для анализа.
  - Считать метрики и для исторического среднего как контрольной модели.
- Пауза для подтверждения пользователем.

## Шаг 10. Итоговое сравнение моделей
- Цель: сравнить портфельные метрики между моделями.
- Важные моменты:
  - Одинаковые периоды по всем моделям.
  - Сравнивать не только Sharpe, но и CAGR/Drawdown.
  - Проверить корректность преобразования risk-free (годовой -> месячный).
- Пауза для подтверждения пользователем.

## Шаг 11. Пакетный запуск без ручного ввода
- Цель: запускать серию экспериментов без интерактива.
- Важные моменты:
  - Важно для ночных прогонов и логирования.
- Пауза для подтверждения пользователем.

## Шаг 12. Синхронизация ноутбуков
- Цель: привести ноутбук в соответствие скриптам.
- Важные моменты:
  - Результаты должны совпадать со скриптами.
- Пауза для подтверждения пользователем.

## Шаг 13. Финальный отчет
- Цель: кратко зафиксировать результаты и ограничения.
- Важные моменты:
  - Описать сильные/слабые стороны и ограничения эксперимента.
- Финальное согласование.
