# План проекта с нуля: команды и ключевые моменты

План рассчитан на пошаговую работу: каждый шаг выполняется, проверяется
и согласуется перед переходом к следующему.

ВАЖНО: модель PatchTST мы НЕ пишем с нуля. Используем готовый self-supervised
reference-код из официального репозитория:
https://github.com/yuqinie98/PatchTST/tree/main?tab=readme-ov-file

---

## Шаг 1. Подготовка окружения
- Цель: воспроизводимая среда для экспериментов.
- Важные моменты:
  - Зафиксируй версии библиотек (для повторяемости результатов).
  - Проверь, что Python видит нужные пакеты.
  - Запиши версии ключевых библиотек (NumPy, pandas, torch).
- Пауза для подтверждения пользователем.

## Шаг 2. Зафиксировать условия эксперимента
- Цель: определить задачу, метрики, период, тикеры, частоту ребалансировки, ограничения.
- Важные моменты:
  - Нужен единый конфиг, где будут все параметры данных и всех моделей.
  - Этот конфиг используется во всех скриптах и ноутбуках.
  - Явно задать окно train/test (например 5 лет / 1 месяц).
  - Явно задать ограничения на веса (min/max, long-only, gross exposure).
  - Зафиксировать безрисковую ставку и метод ковариации.
  - Зафиксировать способ оценки ковариации (sample или Ledoit-Wolf).
  - Зафиксировать seed и режим детерминизма (если нужен повторяемый результат).
- Пауза для подтверждения пользователем.

## Шаг 3. Загрузка цен
- Цель: получить цены (Adjusted Close).
- Важные моменты:
  - Тикеры и даты должны совпадать с конфигом.
  - Не должно быть пустых колонок или тикеров с одними NaN.
  - Убедиться, что есть именно Adjusted Close (а не Close).
- Пауза для подтверждения пользователем.

## Шаг 4. Построение лог-доходностей
- Цель: подготовить данные для бэктеста.
- Важные моменты:
  - Длина данных = N-1 относительно цен.
  - Проверить NaN/inf после преобразований.
  - Удалить пропуски: `dropna()` по строкам (если есть NaN хотя бы в одном тикере).
- Пауза для подтверждения пользователем.

## Шаг 5. Валидация структуры данных
- Цель: убедиться, что данные синхронизированы по датам.
- Важные моменты:
  - Нет пропусков дат, дубликатов, рассинхронизации колонок.
  - Проверь, что формат дат и частота соответствуют торговым дням.
  - Проверь отсутствие утечки данных: train использует только прошлые даты.
  - Убедись, что календарь ребалансировки одинаковый для всех моделей.
- Пауза для подтверждения пользователем.

## Шаг 6. Историческое среднее (Historical Mean)
- Цель: бэктест Марковица с μ = историческое среднее.
- Важные моменты:
  - Сделать короткий пробный прогон (1-2 тикера или укороченный период).
  - Ребалансировка раз в месяц, внутри месяца buy-and-hold.
  - Сохраняй веса на каждом шаге (для последующего анализа).
  - Убедиться, что окна train/test совпадают с другими моделями.
  - Проверить, что ограничения оптимизатора реально соблюдаются (min/max, long-only, gross exposure).
- Пауза для подтверждения пользователем.

## Шаг 7. StatsForecast AutoARIMA
- Цель: прогноз 21 дневной доходности и расчет μ.
- Важные моменты:
  - Горизонт прогноза = 21 день.
  - Нужен fallback, если модель не сошлась по тикеру.
  - Контролировать параметры AutoARIMA (max_p, max_d, max_q, stepwise).
- Пауза для подтверждения пользователем.

## Шаг 8. PatchTST (self-supervised reference)
- Цель: прогноз с PatchTST и расчет μ.
- Важные моменты:
  - Pretrain + finetune на каждом шаге бэктеста.
  - Проверить корректный выбор устройства (MPS/CUDA/CPU).
  - Зафиксировать режим обучения (fast/full) и все гиперпараметры.
  - Логировать время обучения и загрузку ресурсов.
- Пауза для подтверждения пользователем.

## Шаг 9. Метрики прогноза (месячные)
- Цель: сравнить прогноз месячной доходности с фактом.
- Важные моменты:
  - Месячный прогноз = сумма 21 дневной лог-доходности.
  - **RMSE**: среднеквадратичная ошибка прогноза (точность по величине).
  - **MAE**: средняя абсолютная ошибка прогноза (робастная метрика).
  - **Hit Rate**: доля совпадений знака прогноза с фактом (directional accuracy).
  - Hit Rate считать по знаку, игнорируя нули/NaN.
  - Сохранять прогнозы и факты по каждому тикеру для анализа.
  - Считать метрики и для исторического среднего как контрольной модели.
- Пауза для подтверждения пользователем.

## Шаг 10. Итоговое сравнение моделей
- Цель: сравнить портфельные метрики между моделями.
- Важные моменты:
  - Одинаковые периоды по всем моделям.
  - **Sharpe Ratio**: риск-скорректированная доходность (excess return / volatility).
  - **Calmar Ratio**: годовая доходность / |Max Drawdown| (reward/risk, устойчивость к просадкам).
  - Сравнивать не только Sharpe, но и CAGR/Drawdown/Calmar.
  - Проверить корректность преобразования risk-free (годовой -> месячный).
- Пауза для подтверждения пользователем.

## Шаг 11. Анализ ребалансировки портфелей
- Цель: оценить стабильность весов и частоту торгов.
- Важные моменты:
  - **Turnover**: среднее изменение весов между периодами (Σ|w_t - w_{t-1}| / 2).
  - Высокий turnover → высокие транзакционные издержки.
  - Сравнить turnover между моделями (PatchTST vs Baseline).
  - Визуализация: heatmap весов во времени, траектории весов по активам.
  - Волатильность весов по активам (стандартное отклонение веса каждого тикера).
- Пауза для подтверждения пользователем.

## Шаг 12. Пакетный запуск без ручного ввода
- Цель: запускать серию экспериментов без интерактива.
- Важные моменты:
  - Важно для ночных прогонов и логирования.
  - **Визуализация**: график кумулятивных доходностей всех моделей.
  - Сохранение графика в файл (cumulative_returns_{timestamp}.png).
  - Вывод финального роста капитала ($1 → $X) для каждой модели.
- Пауза для подтверждения пользователем.

## Шаг 13. Синхронизация ноутбуков
- Цель: привести ноутбук в соответствие скриптам.
- Важные моменты:
  - Результаты должны совпадать со скриптами.
  - Добавить все новые метрики (Calmar, RMSE, MAE, Hit Rate).
  - Добавить анализ ребалансировки (turnover, heatmaps, траектории весов).
- Пауза для подтверждения пользователем.

## Шаг 14. Финальный отчет
- Цель: кратко зафиксировать результаты и ограничения.
- Важные моменты:
  - Описать сильные/слабые стороны и ограничения эксперимента.
- Финальное согласование.
